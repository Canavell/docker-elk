<source>
  @type tail
  path /home/stas/dev/www/dasart/public/my_app1.log
  pos_file /var/log/td-agent/php_app.pos
  read_from_head true
  tag php_app_log
  <parse>
    @type regexp
    expression /^\[(?<time>.*)\]\s(?<env>.*)\.(?<severity>.*)\:\s(?<message>.*)\s(?<context>(\{.*?\})) \[\]$/
    time_format %iso8601
  </parse>
</source>
 
<filter php_app_log>
  @type record_transformer
  enable_ruby
  <record>
    hostname "#{Socket.gethostname}"
  </record>
</filter>

<filter php_app_log>
  @type parser
  key_name context
  reserve_data true
  <parse>
    @type json
  </parse>
</filter>

<match php_app_log>
  @type copy
  <store>
    @type elasticsearch
    host https://127.0.0.1:9200
    ca_file /home/stas/docker-elk/ssl/certs/rootCA.crt
    user elastic
    password changeme
    logstash_format true
    logstash_prefix php_app_log
    index_name fluentd-.${tag}
    <buffer>
        @type file
        path /var/log/td-agent/buffer/td/php_app
        flush_mode interval
        retry_type exponential_backoff
        flush_thread_count 2
        flush_interval 5s
        retry_forever
        retry_max_interval 30
        chunk_limit_size 2M
        queue_limit_length 100
        overflow_action block
    </buffer>
  </store>
  <store>
    @type stdout
  </store>
</match>